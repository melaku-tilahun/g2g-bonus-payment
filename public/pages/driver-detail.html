<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Details - Bonus Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-light">
    <!-- Header injected by ui.js -->

    <div class="container mt-4">
        <div id="driverHeader" class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 id="driverName">Loading...</h2>
                        <p class="text-muted mb-0" id="driverId">ID: </p>
                        <p class="text-muted mb-0" id="driverPhone">Phone: </p>
                    </div>
                    <div class="text-end">
                        <span id="verificationStatus" class="badge bg-secondary mb-2">Loading...</span>
                        <div id="verifyAction"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Accumulated Bonus</h5>
                        <h1 class="display-5 fw-bold text-primary" id="totalBonus">0.00 ETB</h1>
                        <p class="text-muted" id="weeksCount">0 weeks pending</p>
                        <button class="btn btn-primary w-100 mb-3 d-none" id="payBtn" data-bs-toggle="modal" data-bs-target="#paymentModal">Process Payment</button>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>First Week:</span>
                            <span id="firstWeek">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Latest Week:</span>
                            <span id="lastWeek">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Bonus History</h5>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="loadBonuses('date', 'desc')">Newest First</button>
                                <button class="btn btn-outline-secondary" onclick="loadBonuses('date', 'asc')">Oldest First</button>
                            </div>
                        </div>
                        <div id="periodSummary" class="alert alert-info py-2 mb-3 d-none">
                            <small id="summaryText"></small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Week Date</th>
                                        <th>Amount</th>
                                        <th>Import Date</th>
                                        <th>File Name</th>
                                    </tr>
                                </thead>
                                <tbody id="bonusTableBody">
                                    <tr><td colspan="4" class="text-center">Loading bonuses...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Process Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Total Amount (ETB)</label>
                            <input type="number" id="payAmount" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Date</label>
                            <input type="date" id="payDate" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select id="payMethod" class="form-select">
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Telebirr">Telebirr</option>
                                <option value="Cash">Cash</option>
                                <option value="CBE Birr">CBE Birr</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea id="payNotes" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPaymentBtn">Record Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Verify Modal -->
    <div class="modal fade" id="verifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verify Driver</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to mark this driver as verified? This will block future bonus accumulation in this system.</p>
                    <div class="mb-3">
                        <label class="form-label">Verification Date</label>
                        <input type="date" id="verifyDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Your Password (to confirm)</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Enter your password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmVerifyBtn">Confirm Verification</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/ui.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const driverId = urlParams.get('id');

        if (!driverId) {
            window.location.href = '/index.html';
        }

        async function loadDriverData() {
            try {
                const response = await fetch(`/api/drivers/${driverId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const driver = await response.json();
                
                document.getElementById('driverName').textContent = driver.full_name;
                document.getElementById('driverId').textContent = `ID: ${driver.driver_id}`;
                document.getElementById('driverPhone').textContent = `Phone: ${driver.phone_number || 'N/A'}`;
                
                const statusBadge = document.getElementById('verificationStatus');
                statusBadge.textContent = driver.verified ? 'Verified' : 'Unverified';
                statusBadge.className = `badge mb-2 ${driver.verified ? 'bg-success' : 'bg-warning text-dark'}`;

                const verifyAction = document.getElementById('verifyAction');
                if (!driver.verified) {
                    verifyAction.innerHTML = `<button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#verifyModal">Mark as Verified</button>`;
                } else {
                    verifyAction.innerHTML = `<p class="small text-muted mb-0">Verified on ${new Date(driver.verified_date).toLocaleDateString()}</p>`;
                }

                const totalResponse = await fetch(`/api/bonuses/driver/${driverId}/total`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const totalData = await totalResponse.json();
                
                const totalAmount = parseFloat(totalData.total_bonus || 0);
                document.getElementById('totalBonus').textContent = `${totalAmount.toLocaleString()} ETB`;
                document.getElementById('weeksCount').textContent = `${totalData.weeks_count || 0} weeks pending`;
                document.getElementById('firstWeek').textContent = totalData.first_week ? new Date(totalData.first_week).toLocaleDateString() : '-';
                document.getElementById('lastWeek').textContent = totalData.last_week ? new Date(totalData.last_week).toLocaleDateString() : '-';

                const payBtn = document.getElementById('payBtn');
                if (totalAmount > 0 && !driver.verified) {
                    payBtn.classList.remove('d-none');
                    document.getElementById('payAmount').value = totalAmount;
                } else {
                    payBtn.classList.add('d-none');
                }

                loadBonuses();
            } catch (error) {
                console.error(error);
            }
        }

        document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
            const amount = document.getElementById('payAmount').value;
            const date = document.getElementById('payDate').value;
            const method = document.getElementById('payMethod').value;
            const notes = document.getElementById('payNotes').value;

            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        driver_id: driverId,
                        total_amount: amount,
                        payment_date: date,
                        payment_method: method,
                        notes: notes
                    })
                });
                if (!response.ok) throw new Error('Payment failed');
                alert('Payment recorded successfully');
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('payDate').valueAsDate = new Date();

        async function loadBonuses(sortBy = 'date', order = 'desc') {
            try {
                const response = await fetch(`/api/bonuses/driver/${driverId}?sortBy=${sortBy}&order=${order}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const bonuses = await response.json();
                
                const tbody = document.getElementById('bonusTableBody');
                tbody.innerHTML = '';

                if (!bonuses || bonuses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No bonus records found</td></tr>';
                    document.getElementById('periodSummary').classList.add('d-none');
                    return;
                }

                let minDate = new Date(bonuses[0].week_date);
                let maxDate = new Date(bonuses[0].week_date);
                let total = 0;

                bonuses.forEach(b => {
                    const bDate = new Date(b.week_date);
                    if (bDate < minDate) minDate = bDate;
                    if (bDate > maxDate) maxDate = bDate;
                    total += parseFloat(b.net_payout);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${bDate.toLocaleDateString()}</td>
                        <td>${parseFloat(b.net_payout).toLocaleString()} ETB</td>
                        <td>${new Date(b.imported_at).toLocaleDateString()}</td>
                        <td>${b.file_name || 'Manual'}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('periodSummary').classList.remove('d-none');
                document.getElementById('summaryText').textContent = `Breakdown for period: ${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()} | Total: ${total.toLocaleString()} ETB`;

            } catch (error) {
                console.error(error);
            }
        }

        document.getElementById('confirmVerifyBtn').addEventListener('click', async () => {
            const verifiedDate = document.getElementById('verifyDate').value;
            const password = document.getElementById('confirmPassword').value;
            
            if (!password) {
                alert('Please enter your password to confirm');
                return;
            }

            try {
                const response = await fetch(`/api/drivers/${driverId}/verify`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        verified_date: verifiedDate || new Date(),
                        password: password
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Verification failed');
                
                location.reload();
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('verifyDate').valueAsDate = new Date();

        loadDriverData();
    </script>
</body>
</html>