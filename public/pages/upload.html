<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Excel - Driver Bonus Platform</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body class="bg-light">
    <!-- Header injected by ui.js -->

    <div class="container mt-4">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h3 class="card-title">Import Weekly Bonus Excel</h3>
          <p class="text-muted">
            Upload the weekly bonus Excel file. The system will automatically
            parse and accumulate bonuses for unverified drivers.
          </p>

          <form id="uploadForm" class="mt-4">
            <div class="row align-items-end">
              <div class="col-md-5 mb-3">
                <label for="excelFile" class="form-label"
                  >Select Excel File (.xlsx)</label
                >
                <input
                  class="form-control"
                  type="file"
                  id="excelFile"
                  accept=".xlsx"
                  required
                />
              </div>
              <div class="col-md-4 mb-3">
                <label for="weekDate" class="form-label">Week Date</label>
                <input
                  class="form-control"
                  type="date"
                  id="weekDate"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <button
                  type="submit"
                  class="btn btn-primary w-100"
                  id="uploadBtn"
                  disabled
                >
                  Upload and Process
                </button>
              </div>
            </div>
          </form>

          <!-- Validation Checklist -->
          <div id="validationSection" class="mt-4 d-none">
            <h5>Pre-upload Validation</h5>
            <div id="checklistItems" class="list-group mb-3"></div>
            <div id="validationMsg" class="alert d-none"></div>
          </div>

          <div id="uploadStatus" class="mt-4 d-none">
            <div class="progress mb-3">
              <div
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 100%"
              ></div>
            </div>
            <p class="text-center">Processing file, please wait...</p>
          </div>

          <div id="results" class="mt-4 d-none">
            <h4>Import Summary</h4>
            <div class="row text-center mt-3">
              <div class="col-md-4">
                <div class="p-3 border rounded bg-success text-white">
                  <h2 id="successCount">0</h2>
                  <div>Success</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded bg-warning text-dark">
                  <h2 id="skippedCount">0</h2>
                  <div>Skipped (Verified)</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded bg-danger text-white">
                  <h2 id="errorCount">0</h2>
                  <div>Errors</div>
                </div>
              </div>
            </div>

            <div id="skippedList" class="mt-4 d-none">
              <h5 class="mt-4">Skipped Drivers</h5>
              <ul class="list-group" id="skippedItems"></ul>
            </div>

            <div id="errorList" class="mt-4 d-none">
              <h5 class="mt-4">Row Errors</h5>
              <ul class="list-group" id="errorItems"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h4>Import History</h4>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Week Date</th>
                  <th>File Name</th>
                  <th>Total</th>
                  <th>New</th>
                  <th>Success</th>
                  <th>Skipped</th>
                  <th>Errors</th>
                  <th>By</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <tr>
                  <td colspan="7" class="text-center">Loading history...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/ui.js"></script>
    <script>
        async function loadHistory() {
            try {
                const response = await fetch('/api/uploads/history', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const history = await response.json();
                
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                if (!history || history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">No history found</td></tr>';
                    return;
                }

                history.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${new Date(item.imported_at).toLocaleString()}</td>
                        <td>${new Date(item.week_date).toLocaleDateString()}</td>
                        <td>${item.file_name}</td>
                        <td>${item.total_records}</td>
                        <td class="text-primary">${item.new_drivers_count || 0}</td>
                        <td class="text-success">${item.success_count}</td>
                        <td class="text-warning">${item.skipped_count}</td>
                        <td class="text-danger">${item.error_count}</td>
                        <td>${item.imported_by_name}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error(error);
            }
        }

        const fileInput = document.getElementById('excelFile');
        const uploadBtn = document.getElementById('uploadBtn');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const validationSection = document.getElementById('validationSection');
            const checklistItems = document.getElementById('checklistItems');
            const validationMsg = document.getElementById('validationMsg');

            validationSection.classList.remove('d-none');
            checklistItems.innerHTML = '<div class="text-center p-3">Validating...</div>';
            validationMsg.classList.add('d-none');
            uploadBtn.disabled = true;

            try {
                const response = await fetch('/api/uploads/validate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                const data = await response.json();

                checklistItems.innerHTML = '';
                data.checklist.forEach(check => {
                    const item = document.createElement('div');
                    item.className = `list-group-item d-flex justify-content-between align-items-center`;
                    item.innerHTML = `
                        <span>${check.item}</span>
                        <span>${check.icon}</span>
                    `;
                    checklistItems.appendChild(item);
                });

                validationMsg.textContent = data.message || (data.ready_for_import ? 'File is valid' : 'Validation failed');
                validationMsg.className = `alert mt-2 ${data.ready_for_import ? 'alert-success' : 'alert-danger'}`;
                validationMsg.classList.remove('d-none');

                if (data.ready_for_import) {
                    uploadBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                validationMsg.textContent = 'Validation error occurred';
                validationMsg.className = 'alert alert-danger mt-2';
                validationMsg.classList.remove('d-none');
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = fileInput.files[0];
            const weekDate = document.getElementById('weekDate').value;
            if (!file || !weekDate) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('week_date', weekDate);

            const status = document.getElementById('uploadStatus');
            const results = document.getElementById('results');

            uploadBtn.disabled = true;
            status.classList.remove('d-none');
            results.classList.add('d-none');

            try {
                const response = await fetch('/api/uploads/excel', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Upload failed');

                document.getElementById('successCount').textContent = data.success_count;
                document.getElementById('skippedCount').textContent = data.skipped_count;
                document.getElementById('errorCount').textContent = data.error_count;

                const skippedItems = document.getElementById('skippedItems');
                skippedItems.innerHTML = '';
                if (data.skipped_count > 0) {
                    data.skipped_details.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = `${item.name} (${item.driver_id}): ${item.reason}`;
                        skippedItems.appendChild(li);
                    });
                    document.getElementById('skippedList').classList.remove('d-none');
                } else {
                    document.getElementById('skippedList').classList.add('d-none');
                }

                const errorItems = document.getElementById('errorItems');
                errorItems.innerHTML = '';
                if (data.error_count > 0) {
                    data.errors.forEach(err => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item list-group-item-danger';
                        li.textContent = `Row ${err.row}: ${err.message}`;
                        errorItems.appendChild(li);
                    });
                    document.getElementById('errorList').classList.remove('d-none');
                } else {
                    document.getElementById('errorList').classList.add('d-none');
                }

                results.classList.remove('d-none');
                loadHistory();
                alert('Import completed successfully!');
            } catch (error) {
                alert(error.message);
            } finally {
                uploadBtn.disabled = false;
                status.classList.add('d-none');
            }
        });

        loadHistory();
    </script>
  </body>
</html>
